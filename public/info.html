<!doctype html>
<html lang="en">

<head>
  <title>EWU Calendar Importer</title>
  <link rel="stylesheet" type="text/css" href="stylesheet.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <h1><a href="/">EWU Calendar Importer</a></h1>
  <div id="root">Loading...</div>

  <br /><hr />
  <p>Created by <a href="//github.com/arafatamim">Tamim Arafat</a> •
     <a href="//github.com/arafatamim/ewubd-ical-generator">Source code on GitHub</a> •
     <a href="//github.com/arafatamim/ewubd-ical-generator/issues">Report an issue</a>
  </p>
  <p>Disclaimer: This is a hobby project and not affiliated with <a href="//ewubd.edu">East West University, Bangladesh</a> in any way.
  Use at your own risk.</p>

  <script src="https://cdn.jsdelivr.net/npm/add-to-calendar-button@2.6.21" async defer></script>
  <script type="module">
    const root = document.getElementById("root");

    const calendarRemotePath = new URL(document.location).searchParams.get(
      "calendar_path",
    );

    const fetchCalendar = () =>
      fetch("/api/entries?calendar_path=" + calendarRemotePath);

    const calendar = await fetchCalendar()
      .then((res) => {
        if (!res.ok) {
          root.innerHTML = `<p>Couldn't generate calendar :-( <br />Check if <a href="//ewubd.edu">ewubd.edu</a> loads correctly</p>`;
        } else return res.json();
      })
      .catch((e) => {
        root.innerHTML = `<p>Couldn't generate calendar :-( <br />(${e.message})</p>`;
      });

    if (calendar != null) {
      const calendarName = calendar["calendar_name"];
      const revisedDate = new Date(calendar["revised_date"]);
      const semester = calendar["semester"];
      const year = calendar["year"];

      document.title = `${semester} ${year} calendar - EWU Calendar Importer`;
      const doc = `<h2>${semester} ${year}</h2>
        <h3>${calendarName}</h3>
        <p>Last updated: ${revisedDate.toDateString()}</p>
        <p>
          <add-to-calendar-button
            name="${semester} ${year} ${calendarName}"
            subscribe
            icsFile="https://${window.location.host}/api/generate?calendar_path=${encodeURIComponent(calendarRemotePath)}"
            options="'Google','Apple','Outlook.com','iCal','Microsoft 365','Microsoft Teams','Yahoo'"
            buttonStyle="flat"
            listStyle="dropdown"
            lightMode="dark"
            styleDark="--font: inherit; --btn-background: #01ff70; --btn-text: black; --btn-border: none;"
            hideCheckmark
            inline
          ></add-to-calendar-button> or <a href="/api/generate?calendar_path=${encodeURIComponent(calendarRemotePath)}">download .ics file</a>
        </p>
        <table>
          <tr>
            <th>Date</th>
            <th>Event</th>
          </tr>
          ${calendar.entries
          .map((entry) => {
            const fromDate = new Date(entry.date[0]);
            const toDate =
              entry.date[1] != null ? new Date(entry.date[1]) : null;

            const dateStr =
              toDate == null
                ? fromDate.toDateString()
                : fromDate.toDateString() == toDate.toDateString()
                  ? fromDate.toDateString()
                  : `${fromDate.toDateString()} - ${toDate.toDateString()}`;

            return `
              <tr>
                <td>${dateStr}</td>
                <td>${entry.event}</td>
              </tr>
            `;
          })
          .join("")}
        </table>`;

      root.innerHTML = doc;
    }
  </script>
</body>
</html>
