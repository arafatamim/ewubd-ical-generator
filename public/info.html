<!doctype html>
<html lang="en">
  <head>
    <title>EWU iCal Generator</title>
    <link rel="stylesheet" type="text/css" href="stylesheet.css" />
  </head>

  <body>
    <h1>EWU iCal Generator</h1>
    <div id="root">Loading...</div>

    <script type="module">
      const root = document.getElementById("root");

      const calendarRemotePath = new URL(document.location).searchParams.get(
        "calendar_path",
      );

      const fetchCalendar = () =>
        fetch("/api/entries?calendar_path=" + calendarRemotePath);

      const calendar = await fetchCalendar()
        .then((res) => {
          if (!res.ok) {
            root.innerHTML = `<p>Couldn't generate calendar :-( <br />Check if <a href="//ewubd.edu">ewubd.edu</a> loads correctly</p>`;
          } else return res.json();
        })
        .catch((e) => {
          root.innerHTML = `<p>Couldn't generate calendar :-( <br />(${e.message})</p>`;
        });

      if (calendar != null) {
        const calendarName = calendar["calendar_name"];
        const revisedDate = new Date(calendar["revised_date"]);
        const semester = calendar["semester"];
        const year = calendar["year"];

        document.title = `${semester} ${year} calendar - EWU iCal generator`;
        const doc = `<h2>${semester} ${year}</h2>
        <h3>${calendarName}</h3>
        <p>Last updated: ${revisedDate.toDateString()}</p>
        <p>
          <a href="/api/generate?calendar_path=${calendarRemotePath}">Download</a>
          calendar file (.ics)
        </p>
        <table>
          <tr>
            <th>Date</th>
            <th>Event</th>
          </tr>
          ${calendar.entries.map((entry) => {
            const fromDate = new Date(entry.date[0]);
            const toDate =
              entry.date[1] != null ? new Date(entry.date[1]) : null;

            const dateStr =
              toDate == null
                ? fromDate.toDateString()
                : fromDate.toDateString() == toDate.toDateString()
                  ? fromDate.toDateString()
                  : `${fromDate.toDateString()} - ${toDate.toDateString()}`;

            return `
              <tr>
                <td>${dateStr}</td>
                <td>${entry.event}</td>
              </tr>
            `;
          })}
        </table>`;

        root.innerHTML = doc;
      }
    </script>
  </body>
</html>
